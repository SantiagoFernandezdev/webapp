(window.webpackJsonp=window.webpackJsonp||[]).push([[150],{alRM:function(e,t,s){"use strict";s.r(t),s.d(t,"ControlMapasPageModule",function(){return y});var i=s("ofXK"),a=s("3Pt+"),o=s("TEn/"),n=s("tyNb"),r=s("mrSG"),c=s("iM4M"),l=s("fXoL"),d=s("fsfq"),h=s("2c91"),p=s("oQG1"),u=s("fmoy"),b=s("Bfh1");const m=["mapa"],g=[{path:"",component:(()=>{class e{constructor(e,t,s,i,a,o,n,r,c){this.almacenamiento=e,this.alertCtrl=t,this.apiMapas=s,this.apiUsuario=i,this.toastService=a,this.geoReferencia=o,this.modalCtrl=n,this.popover=r,this.loading=c,this.cargando=!1,this.negocios=[],this.paises=[],this.ciudades=[],this.pais="",this.paiss="",this.miciudad="",this.escogidos=[],this.ciudad=!1,this.sedes=[],this.imagen="",this.lat=0,this.lng=0,this.mensaje="",this.draggable=!1}ngOnInit(){}ionViewWillEnter(){this.listarPaises(),this.listarNegocios(),this.llamarFoto()}calcular(){return Object(r.a)(this,void 0,void 0,function*(){this.loadingg=yield this.loading.create({message:"Cargando Mapa...",spinner:"circles"});try{yield this.loadingg.present();const e=yield this.geoReferencia.getCurrentPosition({enableHighAccuracy:!0,timeout:2e4});e?(this.lat=e.coords.latitude,this.lng=e.coords.longitude,this.traerSedes()):yield this.loadingg.dismiss()}catch(e){yield this.loadingg.dismiss(),this.toastService.toastError("No se pudo capturar su posici\xf3n")}})}llamarFoto(){return Object(r.a)(this,void 0,void 0,function*(){const e=yield this.almacenamiento.obtenerToken();e&&this.apiUsuario.viewImagen(e.token).subscribe(e=>{this.imagen=`https://motocaliapp.com/${e.paquete}`,this.calcular()},e=>{})})}graficar(){mapboxgl.accessToken="pk.eyJ1Ijoic2FudGlhZ29mZXJuYW5kZXpkZXYiLCJhIjoiY2tmYmh6cXdzMDM0bDJ2cHRucTI4cHpkaSJ9.-01EYvsLdJOU1Oy4BtwBwA";const e=new mapboxgl.Map({container:this.mapa.nativeElement,style:"mapbox://styles/mapbox/streets-v11",center:[this.lng,this.lat],zoom:11});e.addControl(new mapboxgl.NavigationControl);const t=document.createElement("div");t.className="marker",t.style.backgroundImage="url(/assets/Marcador.png)",t.style.backgroundSize="100%",t.style.width="50px",t.style.height="70px",new mapboxgl.Marker({element:t,draggable:!1}).setLngLat([this.lng,this.lat]).addTo(e),this.sedes.forEach(t=>{const s=t.creador.imagen.length>0?"https://motocaliapp.com/"+t.creador.imagen[0].path:"/assets/Punto.png",i=document.createElement("div");i.className="marker",i.style.backgroundImage="url("+s+")",i.style.backgroundSize="100%",i.style.width="50px",i.style.height="50px",new mapboxgl.Marker({element:i,draggable:!1}).setLngLat([t.ubicacion.lng,t.ubicacion.lat]).addTo(e),i.addEventListener("click",()=>{this.miModal(t,1)})}),this.loading.dismiss()}traerSedes(){return Object(r.a)(this,void 0,void 0,function*(){const e=yield this.almacenamiento.obtenerToken();e&&this.apiMapas.buscarSedes(e.token,{ciudad:!1,pais:!1,filtros:!1}).subscribe(e=>{e?(this.sedes=e.response,this.graficar()):this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")},e=>{this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")})})}listarNegocios(){this.apiUsuario.negocios().subscribe(e=>{e.exe?(e.response.forEach(e=>{e.checked=!1}),this.negocios=e.response):this.negocios.push("Taller M\xe9canico")},e=>{this.negocios.push("Taller M\xe9canico")})}listarPaises(){this.apiUsuario.listarPaises().subscribe(e=>{e.exe?this.paises=e.response:this.paises.push("Colombia")},e=>{this.paises.push("Colombia")})}listarCiudades(e,t){this.pais=e.detail.value.nombre,this.miciudad="",this.cargando=!0,this.apiUsuario.listarCiudades(e.detail.value._id).subscribe(e=>{e.exe?(this.ciudades=e.response,this.ciudad=!0):this.toastService.toastError("No se pudo traer las ciudades, intente registrarse m\xe1s tarde"),this.cargando=!1},e=>{this.toastService.toastError("No se pudo traer las ciudades, intente registrarse m\xe1s tarde"),this.cargando=!1})}seleccionarCiudad(e){this.miciudad=e.detail.value}miModal(e,t){return Object(r.a)(this,void 0,void 0,function*(){const s=yield this.modalCtrl.create({component:c.a,componentProps:{info:e,vista:t}});yield s.present()})}filtrar(e){return Object(r.a)(this,void 0,void 0,function*(){const t=yield this.popover.create({component:c.a,componentProps:{vista:2},event:e});yield t.present();const s=yield t.onWillDismiss();if(s&&s.data){const e=!!s.data.ciudad&&s.data.ciudad,t=!!s.data.pais&&s.data.pais,i=yield this.almacenamiento.obtenerToken();if(i){const a=yield this.loading.create({message:"Cargando Mapa...",spinner:"circles"});yield a.present(),this.apiMapas.buscarSedes(i.token,{ciudad:e,pais:t,filtros:!0,negocios:s.data.arreglo}).subscribe(e=>{e?(this.sedes=e.response,this.graficar()):this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")},e=>{this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")})}}})}ionViewWillLeave(){this.loadingg.dismiss()}}return e.\u0275fac=function(t){return new(t||e)(l.Lb(d.a),l.Lb(o.b),l.Lb(h.a),l.Lb(p.a),l.Lb(u.a),l.Lb(b.a),l.Lb(o.qb),l.Lb(o.ub),l.Lb(o.ob))},e.\u0275cmp=l.Fb({type:e,selectors:[["app-control-mapas"]],viewQuery:function(e,t){if(1&e&&l.Ac(m,1),2&e){let e;l.oc(e=l.Xb())&&(t.mapa=e.first)}},decls:11,vars:0,consts:[[1,"ion-no-border"],["color","oscuro"],["slot","start","icon","chevron-back-outline","defaultHref","/central/menu/inicioMapa"],["slot","end"],[3,"click"],["name","caret-down-outline","slot","icon-only"],[1,"mapa"],["mapa",""]],template:function(e,t){1&e&&(l.Ob(0,"ion-header",0),l.Ob(1,"ion-toolbar",1),l.Mb(2,"ion-back-button",2),l.Ob(3,"ion-title"),l.wc(4,"Ver Negocios"),l.Nb(),l.Ob(5,"ion-buttons",3),l.Ob(6,"ion-button",4),l.Wb("click",function(e){return t.filtrar(e)}),l.Mb(7,"ion-icon",5),l.Nb(),l.Nb(),l.Nb(),l.Nb(),l.Ob(8,"ion-content"),l.Mb(9,"div",6,7),l.Nb())},directives:[o.z,o.lb,o.g,o.h,o.jb,o.k,o.j,o.A,o.t],styles:[".flexbet[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center}.mapa[_ngcontent-%COMP%]{width:100%;height:100%;background-color:#f3f3f3}"]}),e})()}];let f=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=l.Jb({type:e}),e.\u0275inj=l.Ib({imports:[[n.j.forChild(g)],n.j]}),e})();var v=s("utQI");let y=(()=>{class e{}return e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=l.Jb({type:e}),e.\u0275inj=l.Ib({imports:[[i.b,a.e,o.mb,f,v.a]]}),e})()}}]);
(window.webpackJsonp=window.webpackJsonp||[]).push([[113],{alRM:function(t,e,i){"use strict";i.r(e),i.d(e,"ControlMapasPageModule",function(){return y});var s=i("ofXK"),a=i("3Pt+"),o=i("TEn/"),n=i("tyNb"),r=i("mrSG"),c=i("iM4M"),l=i("fXoL"),d=i("fsfq"),h=i("2c91"),p=i("oQG1"),u=i("fmoy"),b=i("Bfh1");const m=["mapa"],g=[{path:"",component:(()=>{class t{constructor(t,e,i,s,a,o,n,r,c){this.almacenamiento=t,this.alertCtrl=e,this.apiMapas=i,this.apiUsuario=s,this.toastService=a,this.geoReferencia=o,this.modalCtrl=n,this.popover=r,this.loading=c,this.cargando=!1,this.negocios=[],this.paises=[],this.ciudades=[],this.pais="",this.paiss="",this.miciudad="",this.escogidos=[],this.ciudad=!1,this.sedes=[],this.imagen="",this.lat=0,this.lng=0,this.mensaje="",this.draggable=!1}ngOnInit(){}ionViewWillEnter(){this.listarPaises(),this.listarNegocios(),this.llamarFoto()}calcular(){return Object(r.a)(this,void 0,void 0,function*(){this.loadingg=yield this.loading.create({message:"Cargando Mapa...",spinner:"circles"});try{yield this.loadingg.present();const t=yield this.geoReferencia.getCurrentPosition({enableHighAccuracy:!0,timeout:2e4});t?(this.lat=t.coords.latitude,this.lng=t.coords.longitude,this.traerSedes()):yield this.loadingg.dismiss()}catch(t){yield this.loadingg.dismiss(),this.toastService.toastError("No se pudo capturar su posici\xf3n")}})}llamarFoto(){return Object(r.a)(this,void 0,void 0,function*(){const t=yield this.almacenamiento.obtenerToken();t&&this.apiUsuario.viewImagen(t.token).subscribe(t=>{this.imagen=`https://motocaliapp.com/${t.paquete}`,this.calcular()},t=>{})})}graficar(){mapboxgl.accessToken="pk.eyJ1Ijoic2FudGlhZ29mZXJuYW5kZXpkZXYiLCJhIjoiY2tmYmh6cXdzMDM0bDJ2cHRucTI4cHpkaSJ9.-01EYvsLdJOU1Oy4BtwBwA";const t=new mapboxgl.Map({container:this.mapa.nativeElement,style:"mapbox://styles/mapbox/streets-v11",center:[this.lng,this.lat],zoom:11});t.addControl(new mapboxgl.NavigationControl);const e=document.createElement("div");e.className="marker",e.style.backgroundImage="url(/assets/Marcador.png)",e.style.backgroundSize="100%",e.style.width="50px",e.style.height="70px",new mapboxgl.Marker({element:e,draggable:!1}).setLngLat([this.lng,this.lat]).addTo(t),this.sedes.forEach(e=>{const i=e.creador.imagen.length>0?"https://motocaliapp.com/"+e.creador.imagen[0].path:"/assets/Punto.png",s=document.createElement("div");s.className="marker",s.style.backgroundImage="url("+i+")",s.style.backgroundSize="100%",s.style.width="50px",s.style.height="50px",new mapboxgl.Marker({element:s,draggable:!1}).setLngLat([e.ubicacion.lng,e.ubicacion.lat]).addTo(t),s.addEventListener("click",()=>{this.miModal(e,1)})}),this.loading.dismiss()}traerSedes(){return Object(r.a)(this,void 0,void 0,function*(){const t=yield this.almacenamiento.obtenerToken();t&&this.apiMapas.buscarSedes(t.token,{ciudad:!1,pais:!1,filtros:!1}).subscribe(t=>{t?(this.sedes=t.response,this.graficar()):this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")},t=>{this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")})})}listarNegocios(){this.apiUsuario.negocios().subscribe(t=>{t.exe?(t.response.forEach(t=>{t.checked=!1}),this.negocios=t.response):this.negocios.push("Taller M\xe9canico")},t=>{this.negocios.push("Taller M\xe9canico")})}listarPaises(){this.apiUsuario.listarPaises().subscribe(t=>{t.exe?this.paises=t.response:this.paises.push("Colombia")},t=>{this.paises.push("Colombia")})}listarCiudades(t,e){this.pais=t.detail.value.nombre,this.miciudad="",this.cargando=!0,this.apiUsuario.listarCiudades(t.detail.value._id).subscribe(t=>{t.exe?(this.ciudades=t.response,this.ciudad=!0):this.toastService.toastError("No se pudo traer las ciudades, intente registrarse m\xe1s tarde"),this.cargando=!1},t=>{this.toastService.toastError("No se pudo traer las ciudades, intente registrarse m\xe1s tarde"),this.cargando=!1})}seleccionarCiudad(t){this.miciudad=t.detail.value}miModal(t,e){return Object(r.a)(this,void 0,void 0,function*(){const i=yield this.modalCtrl.create({component:c.a,componentProps:{info:t,vista:e}});yield i.present()})}filtrar(t){return Object(r.a)(this,void 0,void 0,function*(){const e=yield this.popover.create({component:c.a,componentProps:{vista:2},event:t});yield e.present();const i=yield e.onWillDismiss();if(i&&i.data){const t=!!i.data.ciudad&&i.data.ciudad,e=!!i.data.pais&&i.data.pais,s=yield this.almacenamiento.obtenerToken();if(s){const a=yield this.loading.create({message:"Cargando Mapa...",spinner:"circles"});yield a.present(),this.apiMapas.buscarSedes(s.token,{ciudad:t,pais:e,filtros:!0,negocios:i.data.arreglo}).subscribe(t=>{t?(this.sedes=t.response,this.graficar()):this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")},t=>{this.toastService.toastError("No se pudo traer las sedes, int\xe9ntelo m\xe1s tarde")})}}})}ionViewWillLeave(){this.loadingg.dismiss()}}return t.\u0275fac=function(e){return new(e||t)(l.Jb(d.a),l.Jb(o.b),l.Jb(h.a),l.Jb(p.a),l.Jb(u.a),l.Jb(b.a),l.Jb(o.ob),l.Jb(o.sb),l.Jb(o.mb))},t.\u0275cmp=l.Db({type:t,selectors:[["app-control-mapas"]],viewQuery:function(t,e){if(1&t&&l.vc(m,1),2&t){let t;l.kc(t=l.Vb())&&(e.mapa=t.first)}},decls:11,vars:0,consts:[[1,"ion-no-border"],["color","oscuro"],["slot","start","icon","chevron-back-outline","defaultHref","/central/menu/inicioMapa"],["slot","end"],[3,"click"],["name","caret-down-outline","slot","icon-only"],[1,"mapa"],["mapa",""]],template:function(t,e){1&t&&(l.Mb(0,"ion-header",0),l.Mb(1,"ion-toolbar",1),l.Kb(2,"ion-back-button",2),l.Mb(3,"ion-title"),l.rc(4,"Ver Negocios"),l.Lb(),l.Mb(5,"ion-buttons",3),l.Mb(6,"ion-button",4),l.Ub("click",function(t){return e.filtrar(t)}),l.Kb(7,"ion-icon",5),l.Lb(),l.Lb(),l.Lb(),l.Lb(),l.Mb(8,"ion-content"),l.Kb(9,"div",6,7),l.Lb())},directives:[o.z,o.jb,o.g,o.h,o.hb,o.k,o.j,o.A,o.t],styles:[".flexbet[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center}.mapa[_ngcontent-%COMP%]{width:100%;height:100%;background-color:#f3f3f3}"]}),t})()}];let f=(()=>{class t{}return t.\u0275mod=l.Hb({type:t}),t.\u0275inj=l.Gb({factory:function(e){return new(e||t)},imports:[[n.i.forChild(g)],n.i]}),t})();var v=i("utQI");let y=(()=>{class t{}return t.\u0275mod=l.Hb({type:t}),t.\u0275inj=l.Gb({factory:function(e){return new(e||t)},imports:[[s.b,a.e,o.kb,f,v.a]]}),t})()}}]);
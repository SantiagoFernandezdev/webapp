(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{HavB:function(t,e,a){"use strict";a.d(e,"a",function(){return m});var i=a("AytR"),o=a("tk/3"),s=a("coGc"),r=a("lJxs"),n=a("IzEk"),c=a("MtjB"),d=a("JIr8"),h=a("PqYM"),l=a("Cfvw"),p=a("fXoL"),u=a("tyNb"),b=a("B7Rs");let m=(()=>{class t{constructor(t,e,a){this.http=t,this.router=e,this.MmyTransfer=a}hanflerError(t){return t.pipe(Object(s.a)(()=>Object(h.a)(3e3)),Object(r.a)(t=>{if(console.log("Entramos a intentos"),t instanceof ErrorEvent)throw new Error("Error de Red");if(404===t.status)throw new Error(" P\xe1gina no encontrada");if(401===t.status)throw new Error(" No tiene permisos ")}),Object(n.a)(3))}crearPedido(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/crear/`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}misPedido(t){const e={headers:new o.c({"x-token":t})};return this.http.get(`${i.a}/pedidos/lista/`,e).pipe(Object(c.a)(t=>this.hanflerError(t)))}misChats(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/chats/lista/`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}misPedidoUsuario(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/lista/`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}misSalas(t){const e={headers:new o.c({"x-token":t})};return this.http.get(`${i.a}/ticket/salas`,e).pipe(Object(c.a)(t=>this.hanflerError(t)))}mensajes(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/chat`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}traermensajesNoVistos(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/chat/vistos`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}marcarvisto(t,e){const a={headers:new o.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/chat/vistos`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}infoPedido(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/info`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}infoPedidoPut(t,e){const a={headers:new o.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/info`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}crearEstados(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/estados`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarEstados(t,e){const a={headers:new o.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/estados`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarChat(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/unico/consultar/chat`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarChatFotos(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/unico/consultar/chat/fotos`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarSala(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/consultar/chat`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarMapa(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/consultar/mapa`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarMapaUnico(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/consultar/mapa/unico`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}crearMapa(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/crear/mapa`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarMapa(t,e){const a={headers:new o.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/editar/mapa`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarMapaInfo(t,e){const a={headers:new o.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/editar/mapa/info`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarMapaInfoD(t,e){const a={headers:new o.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/editar/mapa/infod`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarPedido(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/editar`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarChat(t,e){const a={headers:new o.c({"x-token":t})};return this.http.post(`${i.a}/chat/editar`,e,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}subirArchivosChat(t,e,a,o,s,r,n){console.log("archivo",a);const c={fileKey:"archivo",fileName:r,mimeType:n,httpMethod:"PUT",headers:{"x-token":t,"x-sala":e,"x-final":o,"x-cont":s}},h=this.MmyTransfer.create();return Object(l.a)(h.upload(a,`${i.a}/pedido/upload`,c)).pipe(Object(d.a)(t=>{throw new Error(a)}))}subirweb(t,e,a,s,r){console.log(t,e,a,s);const n={headers:new o.c({"x-token":t,"x-sala":e,"x-final":a.toString(),"x-cont":s.toString()})};return this.http.put(`${i.a}/pedido/upload`,r,n).pipe(Object(c.a)(t=>this.hanflerError(t)))}}return t.\u0275fac=function(e){return new(e||t)(p.Qb(o.a),p.Qb(u.g),p.Qb(b.a))},t.\u0275prov=p.Fb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},uIXr:function(t,e,a){"use strict";a.r(e),a.d(e,"PedidosMapaPageModule",function(){return w});var i=a("ofXK"),o=a("3Pt+"),s=a("TEn/"),r=a("tyNb"),n=a("mrSG"),c=a("HDdC"),d=a("fXoL"),h=a("fsfq"),l=a("fmoy"),p=a("HavB"),u=a("7JkF"),b=a("Bfh1"),m=a("cb8P");const g=["mapa"];function f(t,e){if(1&t){const t=d.Nb();d.Mb(0,"ion-button",3),d.Ub("click",function(){return d.lc(t),d.Wb().guardar()}),d.Kb(1,"ion-icon",8),d.Lb()}}function v(t,e){if(1&t){const t=d.Nb();d.Mb(0,"ion-button",3),d.Ub("click",function(){return d.lc(t),d.Wb().entregado()}),d.Kb(1,"ion-icon",8),d.Lb()}}const k=[{path:"",component:(()=>{class t{constructor(t,e,a,i,o,s,r,c,d,h){this.router=t,this.alert=e,this.almacenamiento=a,this.toast=i,this.apiPedidos=o,this.active=s,this.socket=r,this.geoReferencia=c,this.plt=d,this.cargarElementos=h,this.configurando=!1,this.cargado=!1,this.id="",this.texto="",this.estados=[],this.habilitado=!1,this.domicilios=[],this.coord={lat:0,lng:0},this.mensaje="",this.draggable=!0,this.creado=!1,this.parar=!1,this.escucharCoords().subscribe(t=>{t&&(console.log(t),this.graficar2(t.coords))}),this.escucharPedido().subscribe(t=>Object(n.a)(this,void 0,void 0,function*(){if(t){const t=yield this.alert.create({header:"Pedido Entregado",message:this.pedido.domiciliario.nombrecompleto+" finaliz\xf3 tu pedido",buttons:[{text:"Terminar Pedido",cssClass:"botonalerta",handler:()=>{this.router.navigate(["/central/pedidos"])}}]});yield t.present()}})),this.cargarElementos.$cargarRed.subscribe(t=>Object(n.a)(this,void 0,void 0,function*(){"none"===t&&this.almacenamiento.eleminarSala().then(()=>{this.toast.Especial("Perdiste la conexi\xf3n, verifica la red de internet e intenta nuevamente"),this.router.navigate(["/central/pedidos"])}).catch(()=>{this.toast.Especial("Perdiste la conexi\xf3n, verifica la red de internet e intenta nuevamente"),this.router.navigate(["/central/pedidos"])})})),this.plt.resume.subscribe(t=>Object(n.a)(this,void 0,void 0,function*(){"entrega"===this.active.snapshot.paramMap.get("tipo")||"vivo"===this.active.snapshot.paramMap.get("tipo")?this.informaci\u00f3nPedidoVivo():(this.toast.toastError("Se perdi\xf3n la conexi\xf3n, por favor volver a ingresar al pedido"),this.router.navigate(["/central/pedidos"]))}))}ngOnInit(){}ionViewWillEnter(){"entrega"===this.active.snapshot.paramMap.get("tipo")||"vivo"===this.active.snapshot.paramMap.get("tipo")?this.informaci\u00f3nPedidoVivo():this.informaci\u00f3nPedido()}refrescando(){this.parar=!1,"entrega"===this.active.snapshot.paramMap.get("tipo")||"vivo"===this.active.snapshot.paramMap.get("tipo")?this.informaci\u00f3nPedidoVivo():this.informaci\u00f3nPedido()}calcular(){return Object(n.a)(this,void 0,void 0,function*(){try{const t=yield this.geoReferencia.getCurrentPosition({enableHighAccuracy:!0,timeout:2e4});t&&(this.lat=t.coords.latitude,this.lng=t.coords.longitude,this.graficar())}catch(t){this.toast.toastError("No se pudo captruar su ubicaci\xf3n, verifique que el GPS este prendido o int\xe9ntelo m\xe1s tarde")}})}graficar(){mapboxgl.accessToken="pk.eyJ1Ijoic2FudGlhZ29mZXJuYW5kZXpkZXYiLCJhIjoiY2tmYmh6cXdzMDM0bDJ2cHRucTI4cHpkaSJ9.-01EYvsLdJOU1Oy4BtwBwA";const t=new mapboxgl.Map({container:this.mapa.nativeElement,style:"mapbox://styles/mapbox/streets-v11",center:[this.lng,this.lat],zoom:12});t.addControl(new mapboxgl.NavigationControl);const e=document.createElement("div");e.className="marker",e.style.backgroundImage='url("/assets/Marcador.png")',e.style.backgroundSize="100%",e.style.width="50px",e.style.height="80px";const a=new mapboxgl.Marker({element:e,draggable:this.draggable}).setLngLat([this.lng,this.lat]).addTo(t);a.on("dragend",()=>{const t=a.getLngLat();this.lat=t.lat,this.lng=t.lng})}calcular2(){console.log("MAPON"),mapboxgl.accessToken="pk.eyJ1Ijoic2FudGlhZ29mZXJuYW5kZXpkZXYiLCJhIjoiY2tmYmh6cXdzMDM0bDJ2cHRucTI4cHpkaSJ9.-01EYvsLdJOU1Oy4BtwBwA";const t=new mapboxgl.Map({container:this.mapa.nativeElement,style:"mapbox://styles/mapbox/streets-v11",center:[this.pedido.ubicacion.lng,this.pedido.ubicacion.lat],zoom:12});t.addControl(new mapboxgl.NavigationControl);const e=document.createElement("div");e.className="marker",e.style.backgroundImage='url("/assets/Marcador.png")',e.style.backgroundSize="100%",e.style.width="50px",e.style.height="80px",new mapboxgl.Marker({element:e,draggable:!1}).setLngLat([this.pedido.ubicacion.lng,this.pedido.ubicacion.lat]).addTo(t),this.posicion=this.geoReferencia.watchPosition({enableHighAccuracy:!0}).subscribe(e=>{console.log(e.coords," DATOS DEL WATH",this.pedido),this.parar||(this.coord.lat=e.coords.latitude,this.coord.lng=e.coords.longitude,this.socket.emit("coordenadas",{id:this.pedido._id,accesos:this.pedido.pedido.accesos,coord:{lat:e.coords.latitude,lng:e.coords.longitude}}),this.eltemp&&(this.eltemp.style.display="none"),this.eltemp=document.createElement("div"),this.eltemp.className="marker2",this.eltemp.style.backgroundImage='url("/assets/Caja.png")',this.eltemp.style.backgroundSize="100%",this.eltemp.style.width="50px",this.eltemp.style.height="80px",new mapboxgl.Marker({element:this.eltemp,draggable:!1}).setLngLat([this.coord.lng,this.coord.lat]).addTo(t))},t=>{this.toast.toastError("No se pudo captruar su ubicaci\xf3n, verifique que el GPS este prendido o int\xe9ntelo m\xe1s tarde")})}graficar2(t){if(this.creado)this.eltemp&&(this.eltemp.style.display="none"),this.eltemp=document.createElement("div"),this.eltemp.className="marker2",this.eltemp.style.backgroundImage='url("/assets/Caja.png")',this.eltemp.style.backgroundSize="100%",this.eltemp.style.width="50px",this.eltemp.style.height="80px",new mapboxgl.Marker({element:this.eltemp,draggable:!1}).setLngLat([t.lng,t.lat]).addTo(this.mapon);else{mapboxgl.accessToken="pk.eyJ1Ijoic2FudGlhZ29mZXJuYW5kZXpkZXYiLCJhIjoiY2tmYmh6cXdzMDM0bDJ2cHRucTI4cHpkaSJ9.-01EYvsLdJOU1Oy4BtwBwA",this.mapon=new mapboxgl.Map({container:this.mapa.nativeElement,style:"mapbox://styles/mapbox/streets-v11",center:[this.pedido.ubicacion.lng,this.pedido.ubicacion.lat],zoom:12}),this.mapon.addControl(new mapboxgl.NavigationControl);const e=document.createElement("div");if(e.className="marker",e.style.backgroundImage='url("/assets/Marcador.png")',e.style.backgroundSize="100%",e.style.width="50px",e.style.height="80px",new mapboxgl.Marker({element:e}).setLngLat([this.pedido.ubicacion.lng,this.pedido.ubicacion.lat]).addTo(this.mapon),this.pedido.ubicacionactual){console.log(this.pedido.ubicacionactual);const e=document.createElement("div");e.className="marker2",e.style.backgroundImage='url("/assets/Caja.png")',e.style.backgroundSize="100%",e.style.width="50px",e.style.height="80px",this.eltemp=e,new mapboxgl.Marker({element:e}).setLngLat([t.lng,t.lat]).addTo(this.mapon)}this.creado=!0}}"informaci\xf3nPedido"(){return Object(n.a)(this,void 0,void 0,function*(){const t=yield this.almacenamiento.obtenerToken();t&&(this.id=t._id,this.apiPedidos.consultarMapaUnico(t.token,{id:this.active.snapshot.paramMap.get("id")}).subscribe(t=>{console.log(t),t.exe?t.response.length>0&&(this.pedido=t.response[0],this.pedido.ubicacion?(this.lat=this.pedido.ubicacion.lat,this.lng=this.pedido.ubicacion.lng,this.draggable=!1,this.graficar()):this.calcular()):(this.toast.toastError("No se pudo consultar el pedido, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/menu/"])),this.cargado=!0},t=>{this.toast.toastError("No se pudo consultar el pedido, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/menu/"])}))})}"informaci\xf3nPedidoVivo"(){return Object(n.a)(this,void 0,void 0,function*(){const t=yield this.almacenamiento.obtenerToken();t&&(this.id=t._id,this.apiPedidos.consultarMapaUnico(t.token,{id:this.active.snapshot.paramMap.get("id")}).subscribe(t=>{console.log(t),t.exe?t.response.length>0&&(this.pedido=t.response[0],console.log(this.active.snapshot.paramMap.get("tipo")),"vivo"===this.active.snapshot.paramMap.get("tipo")?this.graficar2(this.pedido.ubicacionactual):(console.log("Entrar"),this.calcular2())):(this.toast.toastError("No se pudo consultar el pedido, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/menu/"])),this.cargado=!0},t=>{this.toast.toastError("No se pudo consultar el pedido, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/menu/"])}))})}guardar(){return Object(n.a)(this,void 0,void 0,function*(){const t=yield this.almacenamiento.obtenerToken();if(t){const e=yield this.alert.create({header:"Atenci\xf3n!",message:"\xbfEstas seguro de tu ubicaci\xf3n?, una vez que aceptes no podras cambiarla de nuevo",buttons:[{text:"Cancelar",cssClass:"cancelarAlerta",role:"cancel"},{text:"Confirmar",cssClass:"botonalerta",handler:()=>{""!==this.lat&&""!==this.lng?this.apiPedidos.editarMapa(t.token,{id:this.active.snapshot.paramMap.get("id"),ubicacion:{lat:this.lat,lng:this.lng}}).subscribe(t=>{console.log(t),t.exe?(this.router.navigate(["/central/pedidos/info",t.response.pedido._id]),this.toast.Especial("Ubicaci\xf3n actualizada")):(this.toast.toastError("No se pudo editar la ubicaci\xf3n para el pedido, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/pedidos"])),this.cargado=!0},t=>{this.toast.toastError("No se pudo edita, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/pedidos"])}):this.toast.toastError("No ha seleccionado la ubicaci\xf3n")}}]});yield e.present()}})}escucharCoords(){return new c.a(t=>{this.socket.on("coordenadas",e=>{t.next(e)})})}escucharPedido(){return new c.a(t=>{this.socket.on("finalizarPedido",e=>{t.next(e)})})}entregado(){return Object(n.a)(this,void 0,void 0,function*(){if(yield this.almacenamiento.obtenerToken()){const t=yield this.alert.create({header:"\xbfHas terminado el pedido?!",message:"Al marcar terminar "+this.pedido.destino.nombrecompleto+" ya no recibir\xe1 m\xe1s tu ubicaci\xf3n",buttons:[{text:"Cancelar",cssClass:"cancelarAlerta",role:"cancel"},{text:"Terminar",cssClass:"botonalerta",handler:()=>{this.parar=!0,this.posicion.unsubscribe(),this.socket.emit("finalizarPedido",{pedido:this.pedido})}}]});yield t.present()}})}ionViewWillLeave(){this.parar=!0,this.posicion.unsubscribe()}}return t.\u0275fac=function(e){return new(e||t)(d.Jb(r.g),d.Jb(s.b),d.Jb(h.a),d.Jb(l.a),d.Jb(p.a),d.Jb(r.a),d.Jb(u.a),d.Jb(b.a),d.Jb(s.rb),d.Jb(m.a))},t.\u0275cmp=d.Db({type:t,selectors:[["app-pedidos-mapa"]],viewQuery:function(t,e){if(1&t&&d.vc(g,1),2&t){let t;d.kc(t=d.Vb())&&(e.mapa=t.first)}},decls:13,vars:2,consts:[["color","oscuro"],["slot","start","icon","chevron-back-outline","defaultHref","/central/pedidos"],["slot","end"],[3,"click"],["name","reload-outline","slot","icon-only"],[3,"click",4,"ngIf"],[1,"mapa"],["mapa",""],["name","checkmark-outline","slot","icon-only"]],template:function(t,e){1&t&&(d.Mb(0,"ion-header"),d.Mb(1,"ion-toolbar",0),d.Kb(2,"ion-back-button",1),d.Mb(3,"ion-title"),d.rc(4,"Seguimiento del pedido"),d.Lb(),d.Mb(5,"ion-buttons",2),d.Mb(6,"ion-button",3),d.Ub("click",function(){return e.refrescando()}),d.Kb(7,"ion-icon",4),d.Lb(),d.qc(8,f,2,0,"ion-button",5),d.qc(9,v,2,0,"ion-button",5),d.Lb(),d.Lb(),d.Lb(),d.Mb(10,"ion-content"),d.Kb(11,"div",6,7),d.Lb()),2&t&&(d.zb(8),d.dc("ngIf",e.pedido&&!e.pedido.ubicacion),d.zb(1),d.dc("ngIf",e.pedido&&e.pedido.ubicacionactual&&e.id===e.pedido.domiciliario._id))},directives:[s.z,s.jb,s.g,s.h,s.hb,s.k,s.j,s.A,i.j,s.t],styles:[".mapa[_ngcontent-%COMP%]{width:100%;height:100%}"]}),t})()}];let x=(()=>{class t{}return t.\u0275mod=d.Hb({type:t}),t.\u0275inj=d.Gb({factory:function(e){return new(e||t)},imports:[[r.i.forChild(k)],r.i]}),t})(),w=(()=>{class t{}return t.\u0275mod=d.Hb({type:t}),t.\u0275inj=d.Gb({factory:function(e){return new(e||t)},imports:[[i.b,o.e,s.kb,x]]}),t})()}}]);
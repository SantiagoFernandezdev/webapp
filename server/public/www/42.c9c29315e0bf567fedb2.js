(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{HavB:function(t,e,o){"use strict";o.d(e,"a",function(){return f});var i=o("AytR"),n=o("tk/3"),r=o("coGc"),s=o("lJxs"),a=o("IzEk"),c=o("MtjB"),d=o("JIr8"),h=o("PqYM"),p=o("Cfvw"),l=o("fXoL"),b=o("tyNb"),u=o("B7Rs");let f=(()=>{class t{constructor(t,e,o){this.http=t,this.router=e,this.MmyTransfer=o}hanflerError(t){return t.pipe(Object(r.a)(()=>Object(h.a)(3e3)),Object(s.a)(t=>{if(console.log("Entramos a intentos"),t instanceof ErrorEvent)throw new Error("Error de Red");if(404===t.status)throw new Error(" P\xe1gina no encontrada");if(401===t.status)throw new Error(" No tiene permisos ")}),Object(a.a)(3))}crearPedido(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/crear/`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}misPedido(t){const e={headers:new n.c({"x-token":t})};return this.http.get(`${i.a}/pedidos/lista/`,e).pipe(Object(c.a)(t=>this.hanflerError(t)))}misChats(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/chats/lista/`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}misChatsGrupos(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/chats/lista/grupos`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}misPedidoUsuario(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/lista/`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}misSalas(t){const e={headers:new n.c({"x-token":t})};return this.http.get(`${i.a}/ticket/salas`,e).pipe(Object(c.a)(t=>this.hanflerError(t)))}mensajes(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/chat`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}traermensajesNoVistos(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/chat/vistos`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}marcarvisto(t,e){const o={headers:new n.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/chat/vistos`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}infoPedido(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/info`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}infoPedidoPut(t,e){const o={headers:new n.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/info`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}crearEstados(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/estados`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarEstados(t,e){const o={headers:new n.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/estados`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarChat(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/unico/consultar/chat`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarChatFotos(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/unico/consultar/chat/fotos`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarSala(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/consultar/chat`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarMapa(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/consultar/mapa`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}consultarMapaUnico(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/consultar/mapa/unico`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}crearMapa(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/crear/mapa`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarMapa(t,e){const o={headers:new n.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/editar/mapa`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarMapaInfo(t,e){const o={headers:new n.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/editar/mapa/info`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarMapaInfoD(t,e){const o={headers:new n.c({"x-token":t})};return this.http.put(`${i.a}/pedidos/editar/mapa/infod`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarPedido(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/pedidos/editar`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}editarChat(t,e){const o={headers:new n.c({"x-token":t})};return this.http.post(`${i.a}/chat/editar`,e,o).pipe(Object(c.a)(t=>this.hanflerError(t)))}subirArchivosChat(t,e,o,n,r,s,a){console.log("archivo",o);const c={fileKey:"archivo",fileName:s,mimeType:a,httpMethod:"PUT",headers:{"x-token":t,"x-sala":e,"x-final":n,"x-cont":r}},h=this.MmyTransfer.create();return Object(p.a)(h.upload(o,`${i.a}/pedido/upload`,c)).pipe(Object(d.a)(t=>{throw new Error(o)}))}subirweb(t,e,o,r,s){console.log(t,e,o,r);const a={headers:new n.c({"x-token":t,"x-sala":e,"x-final":o.toString(),"x-cont":r.toString()})};return this.http.put(`${i.a}/pedido/upload`,s,a).pipe(Object(c.a)(t=>this.hanflerError(t)))}}return t.\u0275fac=function(e){return new(e||t)(l.Qb(n.a),l.Qb(b.g),l.Qb(u.a))},t.\u0275prov=l.Fb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},SpuA:function(t,e,o){"use strict";o.d(e,"a",function(){return r});var i=o("wd/R"),n=o("fXoL");let r=(()=>{class t{transform(t){console.log(t,"fechin");let e=i.utc(t).toDate();return i(e).format("dddd, DD MMMM YYYY h:mm:a")}}return t.\u0275fac=function(e){return new(e||t)},t.\u0275pipe=n.Ib({name:"cambioUTC",type:t,pure:!0}),t})()},gx6W:function(t,e,o){"use strict";o.r(e),o.d(e,"ListagruaCompartidosPageModule",function(){return I});var i=o("ofXK"),n=o("3Pt+"),r=o("TEn/"),s=o("tyNb"),a=o("mrSG"),c=o("HDdC"),d=o("R0Ic"),h=o("fXoL"),p=o("fsfq"),l=o("0xwK"),b=o("fmoy"),u=o("7JkF"),f=o("HavB"),g=o("F6wp"),m=o("SpuA");function v(t,e){1&t&&(h.Mb(0,"div",8),h.Mb(1,"h3",9),h.rc(2,"No tienes ninguna solicitud activa en este momento"),h.Lb(),h.Lb())}function x(t,e){if(1&t&&(h.Mb(0,"ion-avatar",30),h.Kb(1,"img",31),h.Lb()),2&t){const t=h.Wb().$implicit;h.dc("@escribiendo",t.escribiendo?"activo":"noactivo"),h.zb(1),h.fc("src","https://www.motocaliapp.com/",t.taller.imagen[0].path,"",h.mc)}}function M(t,e){if(1&t&&(h.Mb(0,"ion-avatar",30),h.Kb(1,"img",31),h.Lb()),2&t){const t=h.Wb().$implicit;h.dc("@escribiendo",t.escribiendo?"activo":"noactivo"),h.zb(1),h.fc("src","https://www.motocaliapp.com/",t.creador.imagen[0].path,"",h.mc)}}function w(t,e){if(1&t&&(h.Mb(0,"strong"),h.rc(1),h.Lb()),2&t){const t=h.Wb().$implicit;h.zb(1),h.tc(" ",t.creador.nombrecompleto,"")}}function O(t,e){if(1&t&&(h.Mb(0,"strong"),h.rc(1),h.Lb()),2&t){const t=h.Wb().$implicit;h.zb(1),h.tc(" ",t.taller.nombrecompleto,"")}}function k(t,e){1&t&&(h.Mb(0,"span"),h.rc(1," Escribiendo..."),h.Lb())}function j(t,e){if(1&t&&(h.Mb(0,"div",32),h.rc(1),h.Lb()),2&t){const t=h.Wb().$implicit;h.zb(1),h.sc(t.novistos)}}function E(t,e){if(1&t){const t=h.Nb();h.Mb(0,"ion-item-sliding"),h.Mb(1,"ion-item",23),h.Ub("click",function(){h.lc(t);const o=e.$implicit;return h.Wb(4).entrar(o)}),h.qc(2,x,2,2,"ion-avatar",24),h.qc(3,M,2,2,"ion-avatar",24),h.Mb(4,"ion-label",25),h.Mb(5,"div",26),h.qc(6,w,2,1,"strong",27),h.qc(7,O,2,1,"strong",27),h.Lb(),h.Mb(8,"div"),h.Mb(9,"strong"),h.rc(10),h.Lb(),h.Lb(),h.Mb(11,"div"),h.rc(12),h.Xb(13,"cambioUTC"),h.Lb(),h.Mb(14,"div",28),h.qc(15,k,2,0,"span",27),h.Lb(),h.qc(16,j,2,1,"div",29),h.Lb(),h.Lb(),h.Lb()}if(2&t){const t=e.$implicit,o=h.Wb(4);h.zb(2),h.dc("ngIf",t.creador._id===o.id),h.zb(1),h.dc("ngIf",t.creador._id!==o.id),h.zb(2),h.dc("@escribiendo",t.escribiendo?"activo":"noactivo"),h.zb(1),h.dc("ngIf",t.creador._id!==o.id),h.zb(1),h.dc("ngIf",t.creador._id===o.id),h.zb(2),h.Bb("ticket","ticket"===t.tipo)("pedido","pedido"===t.tipo)("hoja","hoja"===t.tipo),h.dc("@escribiendo",t.escribiendo?"activo":"noactivo"),h.zb(1),h.tc("Chat Tipo: ",t.tipo,""),h.zb(1),h.dc("@escribiendo",t.escribiendo?"activo":"noactivo"),h.zb(1),h.sc(h.Yb(13,17,t.fecha)),h.zb(3),h.dc("ngIf",t.escribiendo),h.zb(1),h.dc("ngIf",t.novistos>0)}}function L(t,e){if(1&t&&(h.Mb(0,"div",19),h.Mb(1,"div",20),h.rc(2,"Lista de Conversaciones"),h.Lb(),h.Mb(3,"ion-list",21),h.qc(4,E,17,19,"ion-item-sliding",22),h.Lb(),h.Lb()),2&t){const t=h.Wb().$implicit;h.zb(4),h.dc("ngForOf",t.salas)}}function C(t,e){if(1&t&&(h.Mb(0,"ion-card",12),h.Mb(1,"ion-card-header"),h.Kb(2,"app-mapas",13),h.Lb(),h.Mb(3,"strong",14),h.rc(4),h.Xb(5,"cambioUTC"),h.Lb(),h.Mb(6,"ion-card-title",15),h.rc(7),h.Lb(),h.Mb(8,"div",16),h.Mb(9,"p"),h.rc(10),h.Lb(),h.Kb(11,"div",17),h.Mb(12,"div"),h.Mb(13,"strong"),h.rc(14),h.Lb(),h.Lb(),h.Mb(15,"div"),h.Mb(16,"strong"),h.rc(17,"Tel\xe9fono: "),h.Lb(),h.rc(18),h.Lb(),h.Mb(19,"div"),h.Mb(20,"strong"),h.rc(21,"Correo: "),h.Lb(),h.rc(22),h.Lb(),h.Kb(23,"br"),h.Lb(),h.qc(24,L,5,1,"div",18),h.Lb()),2&t){const t=e.$implicit;h.zb(2),h.dc("lng",t.ubicacion.lng)("lat",t.ubicacion.lat),h.zb(2),h.sc(h.Yb(5,10,t.fecha)),h.zb(3),h.tc("",t.creador.nombrecompleto," "),h.zb(3),h.sc(t.descripcion),h.zb(4),h.uc("Ubicado en ",t.creador.ciudad,", ",t.creador.pais,""),h.zb(4),h.tc(" ",t.creador.tel,""),h.zb(4),h.tc(" ",t.creador.correo,""),h.zb(2),h.dc("ngIf",t.salas.length>0)}}function _(t,e){if(1&t&&(h.Mb(0,"div",10),h.qc(1,C,25,12,"ion-card",11),h.Lb()),2&t){const t=h.Wb();h.zb(1),h.dc("ngForOf",t.gruas)}}const P=[{path:"",component:(()=>{class t{constructor(t,e,o,i,n,r,s,c){this.router=t,this.almacenamiento=e,this.apiMonitoreo=o,this.toast=i,this.socket=n,this.alert=r,this.apiPedido=s,this.modal=c,this.cargado=!1,this.gruas=[],this.salas=[],this.usuario="",this.role="",this.id="",this.marcado=!1,this.parar=!1,this.escucharEscritoss().subscribe(t=>{console.log("escribiendo...",t),t.exe&&this.salas.forEach(e=>{e._id===t.idsala&&(console.log("existe"),e.escribiendo=!0,setTimeout(()=>{e.escribiendo=!1},500))})}),this.escucharMarcados().subscribe(t=>{console.log(t,"socket"),this.gruas.forEach(e=>{e._id===t.id&&(e.marcado=!0)})}),this.escucharSacados().subscribe(t=>{this.gruas=this.gruas.filter(e=>e._id!==t.id)}),this.escuchareliminados().subscribe(t=>{this.gruas=this.gruas.filter(e=>e._id!==t.id)}),this.escucharMensaje().subscribe(t=>Object(a.a)(this,void 0,void 0,function*(){if(!this.parar&&(console.log("mensaje",t),t.exe)){const e=yield this.almacenamiento.obtenerToken();if(e){const o=this.salas.filter(e=>e._id===t.resp.sala._id);console.log(o,"data del temp"),this.apiPedido.mensajes(e.token,{idsala:o[0]._id}).subscribe(e=>{this.salas=this.salas.filter(e=>e._id!==t.resp.sala._id),o[0].novistos=e.exe?e.response.length:0,this.salas.unshift(o[0])},e=>{this.salas=this.salas.filter(e=>e._id!==t.resp.sala._id),o[0].novistos=0,this.salas.unshift(o[0])})}}}))}ngOnInit(){}ionViewWillEnter(){this.parar=!0,this.comprobar()}refrescando(){this.comprobar()}entrar(t){this.almacenamiento.insertarChat(t).then(()=>{this.router.navigate(["/central/menu/monitoreo/grua/chat","lista"])}).catch(()=>{this.toast.toastError("No se puede acceder al chat, int\xe9ntelo m\xe1s tarde")})}escucharEscritoss(){return new c.a(t=>{this.socket.on("escribiendoChat",e=>{t.next(e)})})}escucharMensaje(){return new c.a(t=>{this.socket.on("mensajeChat",e=>{t.next(e)})})}escucharMarcados(){return new c.a(t=>{this.socket.on("gruapersona",e=>{t.next(e)})})}escuchareliminados(){return new c.a(t=>{this.socket.on("gruachao",e=>{t.next(e)})})}escucharSacados(){return new c.a(t=>{this.socket.on("gruasacados",e=>{t.next(e)})})}comprobar(){return Object(a.a)(this,void 0,void 0,function*(){const t=yield this.almacenamiento.obtenerToken();t&&(this.gruas=[],this.apiMonitoreo.compartidos(t.token,{}).subscribe(e=>{if(console.log(e,"DATON"),this.cargado=!0,e.exe){let o=e.response.length;new Promise((o,i)=>{e.response.forEach(e=>{e.marcado=!(!e.persona||e.persona!==t._id),this.role=t.role,this.id=t._id,this.usuario=t.nombre,this.apiMonitoreo.consultarChats(t.token,{grua:e._id}).subscribe(i=>{if(i.exe){let n=i.response.length;i.response.forEach(r=>Object(a.a)(this,void 0,void 0,function*(){r.escribiendo=!1,this.socket.emit("iniciochat",{id:r._id}),(yield new Promise((e,o)=>{this.apiPedido.mensajes(t.token,{idsala:r._id}).subscribe(t=>{t.exe?(console.log(t,"RESPUESTA DEL TODO"),r.fechamsg=t.response.lemgth>0?t.response[t.response.length-1]:r.fecha,r.novistos=t.response.length,e(!0)):(r.novistos=0,e(!0))},t=>{r.novistos=0,e(!0)})}))&&(n-=1,0===n&&(e.salas=i.response,console.log(e.salas,"salas",n),e.salas.sort((t,e)=>(console.log(t.novistos),t.novistos<e.novistos?(console.log("meno"),1):t.novistos>e.novistos?(console.log("mayor"),-1):0)),o(!0)),this.cargado=!0)})),0===i.response.length&&(this.cargado=!0)}else this.toast.toastError("No se pudo consultar los chats, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/menu/"]),this.cargado=!0},t=>{this.toast.toastError("No se pudo consultar los chats, int\xe9ntelo m\xe1s tarde"),this.router.navigate(["/central/menu/"])})})}).then(t=>{o-=1,0===o&&(this.gruas=e.response)})}else this.toast.toastError("No se pudo completar la petici\xf3n, int\xe9ntelo m\xe1s tarde")},t=>{this.toast.toastError("No se pudo completar la petici\xf3n, int\xe9ntelo m\xe1s tarde")}))})}ionViewWillLeave(){this.parar=!0}}return t.\u0275fac=function(e){return new(e||t)(h.Jb(s.g),h.Jb(p.a),h.Jb(l.a),h.Jb(b.a),h.Jb(u.a),h.Jb(r.b),h.Jb(f.a),h.Jb(r.pb))},t.\u0275cmp=h.Db({type:t,selectors:[["app-listagrua-compartidos"]],decls:11,vars:2,consts:[[1,"ion-no-border"],["color","oscuro"],["slot","start","icon","chevron-back-outline","defaultHref","/central/menu/monitoreo"],["slot","end"],[3,"click"],["name","reload-outline","slot","icon-only"],["class","flex",4,"ngIf"],["class","opts",4,"ngIf"],[1,"flex"],[1,"titulo"],[1,"opts"],["color","light","mode","ios",4,"ngFor","ngForOf"],["color","light","mode","ios"],[3,"lng","lat"],[1,"gris"],[1,"tit"],[1,"info"],[1,"separador"],["class"," ",4,"ngIf"],[1,""],[1,"separadorr"],[1,"light"],[4,"ngFor","ngForOf"],["color","light",3,"click"],["slot","start",4,"ngIf"],[1,"relativo"],[1,"infoo"],[4,"ngIf"],[1,"escribiendo"],["class","nv",4,"ngIf"],["slot","start"],[3,"src"],[1,"nv"]],template:function(t,e){1&t&&(h.Mb(0,"ion-header",0),h.Mb(1,"ion-toolbar",1),h.Kb(2,"ion-back-button",2),h.Mb(3,"ion-title"),h.rc(4,"Solicitudes compartidas conmigo"),h.Lb(),h.Mb(5,"ion-buttons",3),h.Mb(6,"ion-button",4),h.Ub("click",function(){return e.refrescando()}),h.Kb(7,"ion-icon",5),h.Lb(),h.Lb(),h.Lb(),h.Lb(),h.Mb(8,"ion-content"),h.qc(9,v,3,0,"div",6),h.qc(10,_,2,1,"div",7),h.Lb()),2&t&&(h.zb(9),h.dc("ngIf",e.cargado&&0===e.gruas.length),h.zb(1),h.dc("ngIf",e.cargado))},directives:[r.z,r.kb,r.g,r.h,r.ib,r.k,r.j,r.A,r.t,i.j,i.i,r.l,r.n,g.a,r.p,r.L,r.J,r.F,r.K,r.f],pipes:[m.a],styles:[".flex[_ngcontent-%COMP%]{display:flex;justify-content:center;flex-direction:column;align-items:center;margin:100px 0}.titulo[_ngcontent-%COMP%]{text-align:center;max-width:300px;font-size:18px;font-weight:300}.mapa[_ngcontent-%COMP%]{width:100%;height:300px}.tit[_ngcontent-%COMP%]{font-size:18px}.gris[_ngcontent-%COMP%], .tit[_ngcontent-%COMP%]{padding:10px}.gris[_ngcontent-%COMP%]{color:var(--ion-color-medium)}.info[_ngcontent-%COMP%]{padding:10px}.tp[_ngcontent-%COMP%]{z-index:10;background-color:initial}.ct[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:20px;font-weight:300}.separadorr[_ngcontent-%COMP%]{padding:10px;color:#fff;background-color:#4a4a4a}.msg[_ngcontent-%COMP%]{position:absolute;top:0;right:0;text-align:center;padding:5px 10px;border-radius:10px}.escribiendo[_ngcontent-%COMP%]{color:#627e42;font-weight:700;font-size:14px;height:20px}.relativo[_ngcontent-%COMP%]{position:relative}.nv[_ngcontent-%COMP%]{position:absolute;bottom:5px;right:5px;background-color:#627e42;color:#fff;text-align:center;min-width:20px;min-height:20px;max-width:50px;max-height:50px;border-radius:100%}.infoo[_ngcontent-%COMP%]{font-size:14px}.ticket[_ngcontent-%COMP%]{color:#e53935}.pedido[_ngcontent-%COMP%]{color:orange}.hoja[_ngcontent-%COMP%]{color:#4a4a4a}.marcado[_ngcontent-%COMP%]{width:100%;padding:10px;background-color:#555;color:#fff}"],data:{animation:[Object(d.l)("escribiendo",[Object(d.i)("activo",Object(d.j)({opacity:.5})),Object(d.i)("noactivo",Object(d.j)({opacity:1})),Object(d.k)("activo <=> noactivo",[Object(d.e)("300ms")])])]}}),t})()}];let z=(()=>{class t{}return t.\u0275mod=h.Hb({type:t}),t.\u0275inj=h.Gb({factory:function(e){return new(e||t)},imports:[[s.i.forChild(P)],s.i]}),t})();var $=o("iTUp"),y=o("zon2");let I=(()=>{class t{}return t.\u0275mod=h.Hb({type:t}),t.\u0275inj=h.Gb({factory:function(e){return new(e||t)},imports:[[i.b,n.e,r.lb,z,$.a,y.a]]}),t})()}}]);